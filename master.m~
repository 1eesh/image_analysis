%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%master.m (the first script that you would call when you start analysing
%The algorithm first finds the point of maximmum intensity for each cell 
%and then normalizes the intensity of each of the pixel in the cell by 
%dividing each pixel value with the value of the maximum intensity of a
%pixel in the cell(now each value lies between zero and one). 
%Then it applies a filter that filters out the pixels with intensities 
%less than a certain threshold(15%) and then it finds the weighted 
%centre of mass(centre of intensity) of each of the cells. 
%THis is the Rok Focus of the cells

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%







%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%LOADING DATA AND CHANGING PATHS

clear all;      %clears the current variables in the workspace
res=0.106;      %set the resolution for the image.This is determined by the microscopes, it is 0.2125 if you have 0.2125 microns per pixel, 0.1417 for spn
threshold=0.80; %Set the threshold for segmentation that we will use in our Center of mass algorithm(0.8 means , 80% of maximum intensity is considered
rok=1;          %Flag to recognize when to plot rok and when to plot myosin


%%Loading the data for the Vertices
load('/Users/eesh/Desktop/image_analysis/Membranes--vertices--Vertex-x.mat');
datax=data; %save the data loaded into a variable
cell_number=size(datax,3); % This just assigns 109 to the cel_number for the given file
load('/Users/eesh/Desktop/image_analysis/Membranes--vertices--Vertex-y.mat'); %this loads the y 
datay=data; %save the data loaded into a variable


cell_number=size(datay,3); %Count the number of cells in the image(by looking at size of EDGE DATA)
COM=zeros(cell_number,2);  %Initializing Center of Mass(COM) to all zeros

%%Loading the images into MATLAB variables
A=imread('RokProj_z008_c001.tif');          %Load the Rok Image into A
A_hold=A;                                   %Save the original uint8 Rok image into A_hold(enables imshow(A_hold)
M=imread('MBSProj_z008_c002.tif');          %Load the MBS data into M
Q=imread('MyosinProj_z008_c003.tif');       %Load the Myosin data into Q
C=imread('CellsProj_z008_c003.tif');        %Load the Membrane data into C


imshow(A);                                  %Displays the image A(Rok)
hold on;

%%Converting all variables to a double
A=double(A);                                %Converts A to double for computation
M=double(M);
Q=double(Q);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%







%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Loop over all the cells in the image and find the center of mass of each.
%I call various scripts in this program and I specifically mark the
%location of each script with a line of stars. The address needs to change
%depending on where you execute the scripts.

for cell_index=1:cell_number, 
    
%*************************************************************************%     
   %%SCRIPT TO FIND CENTER OF MASS OF A CELL 
   run('/Users/eesh/Desktop/image_analysis/centerofmass_cell');
%*************************************************************************% 
   

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%This section plots the center of mass onto the image for visual inspection
    plot(COM_X, COM_Y, 'rx');
    h = fill(tx,ty,'r');
    set(h,'FaceColor','None');
    COM;
    hold on;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
   
  
%*************************************************************************% 

    %%RADIAL INTENSITY DISTRIBUTION FOR ROK
    
    run('/Users/eesh/Desktop/image_analysis/radial_distribution.m');
    
    %%THIS PLOTS THE CELL NUMBER ONTO THE CELL
  text( cell(cell_index).COM_X, cell(cell_index).COM_Y, [num2str(cell_index)],'Color', 'g');   
    
    
end
 cell_rok=cell;


%%SAVING ALL THE DATA for ROK into cell_rok

%%plotting myosin onto the Rok plots
%%The mysoin_distribution is stored in a different file for sanity
%%NOW WE PLOT MYOSIN DISTRIBUTION PLOTS IN RED
    %%NOW THE UNIT VECTOR PART BEGINS
 A=M;
 rok=0; %for the plotting to be off   
    for cell_index=1:cell_number,
        
         tx = datax{1,1,cell_index}'./res;

    ty = datay{1,1,cell_index}'./res;

     vert_cell=size(tx,2);
   t_poly=zeros(vert_cell,2);

   for i=1:vert_cell,
       t_poly(i ,1)=tx(i);
       t_poly(i ,2)=ty(i);
   end

   t_poly;
   
 
  run('/Users/eesh/Desktop/image_analysis/radial_distribution.m');
    
end
cell_myosin=cell;

%%THE PLOTS USING SUBPLOT FOR MYOSIN
%COM_threshold(:,:,threshold)=COM;




%%THE PLOTS USING SUBPLOT FOR ROK
%COM_threshold(:,:,threshold)=COM;
k = waitforbuttonpress ;
    hold off;
%%
load('wildtype_rokxmyosin.mat')
  
    start_cell=78;
    end_cell=96;
    
     %%MYOSIN PLOT
 cell=cell_myosin;
 rok=0;%this is just for plotting
  run('/Users/eesh/Desktop/image_analysis/plot_radial.m');

    %%ROK PLOT
    cell=cell_rok;
    rok=1;
    run('/Users/eesh/Desktop/image_analysis/plot_radial.m');

%%
    
%%PLOTTING the AVERAGE intensity Distribution for The Cell
if 0,
k=waitforbuttonpress;
    hold off;
%%   
wild=1;
load('wildtype_rokxmyosin.mat')
%%PLOT FOR MYOSIN AVERAGE IVER CELLS 
 cell=cell_myosin;
    rok=0;
   
 run('/Users/eesh/Desktop/image_analysis/averageovercells.m');
 wild_myosin=average_C(1:30,:);
%%PLOT FOR ROK AVERAGE OVER CELLS 
 cell=cell_rok;
rok=1;

 run('/Users/eesh/Desktop/image_analysis/averageovercells.m'); 
  wild_rok=average_C(1:30,:);
WILD_corr=xcov(wild_myosin,wild_rok,0,'coeff')
 title('Average over all the cells for Wild type Mutant');
 xlabel(strcat('Peason correlation coefficient for the Average plots = ',num2str(WILD_corr)));
 %%THIS IS FOR SPN(average thing
 
 wild=0;
 load('spn_rokxmyosin.mat')
%%PLOT FOR MYOSIN AVERAGE IVER CELLS 
 cell=cell_myosin;
    rok=0;
  subplot(2,1,2)   
 run('/Users/eesh/Desktop/image_analysis/averageovercells.m');
  spn_myosin=average_C(1:30,:);
 title('Average over all the cells for Spn Mutant');
%%PLOT FOR ROK AVERAGE OVER CELLS 
 cell=cell_rok;
rok=1;

 run('/Users/eesh/Desktop/image_analysis/averageovercells.m'); 
 spn_rok=average_C(1:30,:);
 
 SPN_corr=xcov(spn_myosin,spn_rok,0,'coeff')
 xlabel(strcat('Peason correlation coefficient for the Average plots = ',num2str(SPN_corr)));
end